<!DOCTYPE html>
<html>
<head>
    <title>GARCH Model Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 簡単なスタイル */
        body { font-family: sans-serif; margin: 20px; }
        .container { display: flex; gap: 20px; }
        .controls { width: 300px; }
        .chart-container { flex-grow: 1; }
        label { display: block; margin-top: 10px; }
        input[type="number"] { width: 100px; }
        button { margin-top: 20px; padding: 10px; }
    </style>
</head>
<body>
    <h1>GARCH(1,1) Model Simulator</h1>

    <div class="container">
        <div class="controls">
            <h2>Parameters</h2>
            <label for="initialPrice">Initial Price (P0):</label>
            <input type="number" id="initialPrice" value="100">

            <label for="a0">Alpha0 (_a0):</label>
            <input type="number" id="a0" value="0.00001" step="0.000001">

            <label for="a1">Alpha1 (_a1):</label>
            <input type="number" id="a1" value="0.1" step="0.01">

            <label for="a2">Beta1 (_a2):</label>
            <input type="number" id="a2" value="0.85" step="0.01">

            <label for="numSteps">Number of Steps (N):</label>
            <input type="number" id="numSteps" value="200">

            <label for="initialStd">Initial Std (_pre-std, optional):</label>
            <input type="number" id="initialStd" value="0.01" step="0.001">

            <label for="initialShock">Initial Shock (_pre-shock, optional):</label>
            <input type="number" id="initialShock" value="0" step="0.001">

            <label for="drift">Drift per Step (μ0):</label>
            <input type="number" id="drift" value="0" step="0.00001">

            <button onclick="runSimulation()">Run Simulation</button>

            <h2>Results</h2>
            <div id="stats">
                <p>Final Price: <span id="finalPrice">-</span></p>
                <p>Max Price: <span id="maxPrice">-</span></p>
                <p>Min Price: <span id="minPrice">-</span></p>
            </div>
        </div>

        <div class="chart-container">
            <div>
                <canvas id="priceChart"></canvas>
            </div>
            <div>
                <canvas id="volatilityChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let priceChartInstance;
        let volatilityChartInstance;

        function generateUniform(min, max) {
            return Math.random() * (max - min) + min;
        }

        // SkriptのGARCHロジックをJavaScriptで再現
        // SkriptのGARCHロジックをJavaScriptで再現
        function simulateGARCHStep(currentP, preStd, preShock, a0, a1, a2, drift) { // drift パラメータを追加
            let noise = 0;
            for (let i = 0; i < 12; i++) {
                noise += generateUniform(-0.5, 0.5);
            }
            let ep = noise * preStd;

            let currentStd = Math.sqrt(a0 + (a1 * ep * ep) + (a2 * preStd * preStd));
            if (isNaN(currentStd) || currentStd <= 0) {
                currentStd = Math.sqrt(a0) || 0.0001;
            }

            let edge = Math.sqrt(3) * currentStd * 100;
            edge = Math.round(edge);

            let rate = 0;
            for (let i = 0; i < 50; i++) {
                rate += Math.floor(generateUniform(0 - edge, edge + 1));
            }
            rate = rate / (5 * Math.sqrt(2));
            rate = rate / 10000;

            // --- ドリフト項の加算 ---
            rate += drift; // ここでドリフトを加える
            // ----------------------

            let shock = rate; // ドリフトを含んだ後のrateをshockとして記録するかどうかは設計次第
                           // ここではドリフト後のrateを基にする

            let growthRate;
            if (rate < 0) { // ドリフト後のrateで判定
                growthRate = 1 / (1 - rate);
            } else {
                growthRate = 1 + rate;
            }
            if (isNaN(growthRate) || growthRate <= 0) {
                 growthRate = 1;
            }

            let newP = currentP * growthRate;

            return {
                newPrice: newP,
                newStd: currentStd,
                newShock: shock // ドリフト適用後のrateを基にしたショック
            };
        }

        function runSimulation() {
            const initialPrice = parseFloat(document.getElementById('initialPrice').value);
            const a0 = parseFloat(document.getElementById('a0').value);
            const a1 = parseFloat(document.getElementById('a1').value);
            const a2 = parseFloat(document.getElementById('a2').value);
            const numSteps = parseInt(document.getElementById('numSteps').value);
            let initialStd = parseFloat(document.getElementById('initialStd').value);
            let initialShock = parseFloat(document.getElementById('initialShock').value);
            const drift = parseFloat(document.getElementById('drift').value); // ドリフトの値を取得

            if (isNaN(initialStd)) initialStd = Math.sqrt(a0 / (1 - a1 - a2)) || 0.01;
            if (isNaN(initialShock)) initialShock = 0;
            if (isNaN(drift)) drift = 0; // ドリフトがNaNなら0に


            let prices = [initialPrice];
            let volatilities = [initialStd]; // 最初のボラティリティ
            let timeLabels = [0];

            let currentPrice = initialPrice;
            let currentStd = initialStd;
            let currentShock = initialShock;

            for (let i = 1; i <= numSteps; i++) {
                timeLabels.push(i);
                // simulateGARCHStep に drift を渡す
                let result = simulateGARCHStep(currentPrice, currentStd, currentShock, a0, a1, a2, drift);
                currentPrice = result.newPrice;
                currentStd = result.newStd;
                currentShock = result.newShock;

                prices.push(currentPrice);
                volatilities.push(currentStd);
            }

            // Chart.jsでグラフ描画
            if (priceChartInstance) {
                priceChartInstance.destroy();
            }
            const priceCtx = document.getElementById('priceChart').getContext('2d');
            priceChartInstance = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Stock Price',
                        data: prices,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        pointRadius: 0 // 点を非表示に
                    }]
                },
                options: { animation: false }
            });

            if (volatilityChartInstance) {
                volatilityChartInstance.destroy();
            }
            const volCtx = document.getElementById('volatilityChart').getContext('2d');
            volatilityChartInstance = new Chart(volCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Volatility (Std Dev)',
                        data: volatilities,
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: { animation: false }
            });

            // 統計情報
            document.getElementById('finalPrice').textContent = prices[prices.length - 1].toFixed(4);
            document.getElementById('maxPrice').textContent = Math.max(...prices).toFixed(4);
            document.getElementById('minPrice').textContent = Math.min(...prices).toFixed(4);
        }
        // 初期表示
        runSimulation();
    </script>
</body>
</html>